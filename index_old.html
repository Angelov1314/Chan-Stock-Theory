<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼ è®ºæŠ€æœ¯åˆ†æç³»ç»Ÿ</title>
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç¼ è®ºåˆ†æ">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }
        .card-header {
            background-color: #2c3e50;
            color: white;
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }
        .btn-primary {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
        .btn-primary:hover {
            background-color: #34495e;
            border-color: #34495e;
        }
        .form-control:focus {
            border-color: #2c3e50;
            box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
        }
        .loading {
            display: none;
        }
        .chart-container {
            text-align: center;
            margin: 20px 0;
        }
        .chart-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        
        /* ç¾åŒ–è¡¨å•æ ·å¼ */
        .form-control-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
        }
        
        .form-select-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        
        .form-label {
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* å¡ç‰‡é—´è·ä¼˜åŒ– */
        .card-body {
            padding: 2rem;
        }
        
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease-in-out;
        }
        
        /* è¾“å…¥æ¡†èšç„¦æ•ˆæœ */
        .form-control:focus, .form-select:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.15);
            transition: all 0.2s ease-in-out;
        }
        .accuracy-score {
            font-size: 2rem;
            font-weight: bold;
        }
        .accuracy-excellent { color: #28a745; }
        .accuracy-good { color: #17a2b8; }
        .accuracy-fair { color: #ffc107; }
        .accuracy-poor { color: #dc3545; }
        .report-section {
            margin-bottom: 30px;
        }
        .report-section h5 {
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 5px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 20px;
            margin-bottom: 15px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem;
            }
            .btn-lg {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
            .form-control-lg, .form-select-lg {
                padding: 0.5rem 0.75rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>ç¼ è®ºæŠ€æœ¯åˆ†æç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="https://chan-stock-theory.onrender.com" target="_blank">
                    <i class="fas fa-desktop me-1"></i>ç½‘é¡µç‰ˆ
                </a>
                <a class="nav-link" href="#" onclick="showInstallGuide(); return false;">
                    <i class="fas fa-download me-1"></i>å®‰è£…æŒ‡å¯¼
                </a>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarsExampleDefault">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHandbook()"><i class="fas fa-book me-1"></i>æ–°æ‰‹æ‰‹å†Œ</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- åˆ†æè¡¨å• -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-candlestick me-2"></i>ç¼ è®ºæŠ€æœ¯åˆ†æ
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="analysisForm">
                            <div class="row g-3">
                                <!-- ç¬¬ä¸€è¡Œï¼šè‚¡ç¥¨ä»£ç å’Œæ—¶é—´æ¡†æ¶ -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="symbol" class="form-label fw-bold">è‚¡ç¥¨ä»£ç </label>
                                        <input type="text" class="form-control form-control-lg" id="symbol" placeholder="ä¾‹å¦‚: AAPL" value="AAPL" required>
                                        <div class="form-text">è¯·è¾“å…¥è‚¡ç¥¨ä»£ç </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="timeframe" class="form-label fw-bold">æ—¶é—´æ¡†æ¶</label>
                                        <select class="form-select form-select-lg" id="timeframe" required>
                                            <option value="1m">åˆ†çº¿ (1åˆ†é’Ÿ) - æœ€è¿‘7å¤©</option>
                                            <option value="5m">5åˆ†é’Ÿ - æœ€è¿‘60å¤©</option>
                                            <option value="15m">15åˆ†é’Ÿ - æœ€è¿‘60å¤©</option>
                                            <option value="30m">30åˆ†é’Ÿ - æœ€è¿‘60å¤©</option>
                                            <option value="1h">å°æ—¶çº¿ - æœ€è¿‘60å¤©</option>
                                            <option value="1d" selected>æ—¥çº¿ - å®Œæ•´å†å²</option>
                                            <option value="1wk">å‘¨çº¿ - å®Œæ•´å†å²</option>
                                            <option value="1mo">æœˆçº¿ - å®Œæ•´å†å²</option>
                                        </select>
                                        <div class="form-text">é€‰æ‹©Kçº¿å‘¨æœŸï¼ˆæ—¥å†…æ•°æ®ä»…é™æœ€è¿‘å†å²ï¼‰</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary btn-lg w-100" id="analyzeBtn">
                                                <i class="fas fa-search me-2"></i>å¼€å§‹åˆ†æ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ç¬¬äºŒè¡Œï¼šæ—¥æœŸé€‰æ‹© -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start_date" class="form-label fw-bold">å¼€å§‹æ—¥æœŸ</label>
                                        <input type="date" class="form-control form-control-lg" id="start_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="end_date" class="form-label fw-bold">ç»“æŸæ—¥æœŸ</label>
                                        <input type="date" class="form-control form-control-lg" id="end_date" required>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="row mt-4 loading" id="loadingSection">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åˆ†æä¸­...</span>
                        </div>
                        <p class="mt-3 mb-0">æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æç»“æœ -->
        <div class="row mt-4" id="resultsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>åˆ†æç»“æœ
                            <span id="analysisInfo" class="badge bg-light text-dark ms-2"></span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- ç¼ è®ºå›¾è¡¨ -->
                        <div class="chart-container" id="chartContainer">
                            <!-- å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        
                        <!-- è¯„ä¼°æŠ¥å‘Š -->
                        <div id="reportContainer">
                            <!-- æŠ¥å‘Šå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>

                        <!-- äº¤æ˜“æŠ¥å‘Š -->
                        <div class="mt-4" id="tradingReportContainer">
                            <!-- äº¤æ˜“æŠ¥å‘Šå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‡†ç¡®æ€§éªŒè¯ -->
        <div class="row mt-4" id="validationSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>å‡†ç¡®æ€§éªŒè¯
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="validationForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="validation_date" class="form-label fw-bold">éªŒè¯æ—¥æœŸ</label>
                                        <input type="date" class="form-control form-control-lg" id="validation_date" required>
                                        <div class="form-text">é€‰æ‹©è¦éªŒè¯çš„æˆªæ­¢æ—¥æœŸ</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-success btn-lg w-100" id="validateBtn">
                                                <i class="fas fa-check me-2"></i>éªŒè¯å‡†ç¡®æ€§
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="button" class="btn btn-secondary btn-lg w-100" id="resetBtn">
                                                <i class="fas fa-refresh me-2"></i>é‡æ–°åˆ†æ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- éªŒè¯ç»“æœ -->
                        <div id="validationResults" style="display: none;">
                            <!-- éªŒè¯ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>ä½¿ç”¨è¯´æ˜
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-candlestick me-2"></i>åˆ†æåŠŸèƒ½</h6>
                                <ul>
                                    <li><strong>åˆ†å‹è¯†åˆ«</strong>ï¼šè‡ªåŠ¨è¯†åˆ«é¡¶åˆ†å‹å’Œåº•åˆ†å‹</li>
                                    <li><strong>ç¬”æ„å»º</strong>ï¼šè¿æ¥åˆ†å‹å½¢æˆç¬”ç»“æ„</li>
                                    <li><strong>çº¿æ®µåˆ†æ</strong>ï¼šè¯†åˆ«ä¸»è¦è¶‹åŠ¿çº¿æ®µ</li>
                                    <li><strong>ä¸­æ¢æ£€æµ‹</strong>ï¼šå‘ç°ä»·æ ¼éœ‡è¡åŒºé—´</li>
                                    <li><strong>èƒŒé©°åˆ†æ</strong>ï¼šåŸºäºMACDçš„èƒŒé©°ä¿¡å·</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-check-circle me-2"></i>éªŒè¯åŠŸèƒ½</h6>
                                <ul>
                                    <li><strong>åˆ†å‹å‡†ç¡®æ€§</strong>ï¼šéªŒè¯åˆ†å‹è¯†åˆ«å‡†ç¡®æ€§</li>
                                    <li><strong>ç¬”å‡†ç¡®æ€§</strong>ï¼šéªŒè¯ç¬”æ„å»ºå‡†ç¡®æ€§</li>
                                    <li><strong>ä»·æ ¼é¢„æµ‹</strong>ï¼šéªŒè¯ä»·æ ¼é¢„æµ‹å‡†ç¡®æ€§</li>
                                    <li><strong>è¶‹åŠ¿é¢„æµ‹</strong>ï¼šéªŒè¯è¶‹åŠ¿é¢„æµ‹å‡†ç¡®æ€§</li>
                                    <li><strong>ç»¼åˆè¯„åˆ†</strong>ï¼šæ•´ä½“åˆ†æè´¨é‡è¯„ä¼°</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2024 ç¼ è®ºæŠ€æœ¯åˆ†æç³»ç»Ÿ. åŸºäºç¼ è®ºç†è®ºçš„ä¸“ä¸šåˆ†æå·¥å…·.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE = 'https://chan-stock-theory.onrender.com';
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            
            document.getElementById('start_date').value = oneYearAgo.toISOString().split('T')[0];
            document.getElementById('end_date').value = today.toISOString().split('T')[0];
            document.getElementById('validation_date').value = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            // ç›‘å¬æ—¶é—´æ¡†æ¶å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´æ—¥æœŸèŒƒå›´
            document.getElementById('timeframe').addEventListener('change', function() {
                adjustDateRangeForTimeframe();
            });
            
            // é¡µé¢åŠ è½½æ—¶ä¹Ÿè‡ªåŠ¨è°ƒæ•´æ—¥æœŸèŒƒå›´
            adjustDateRangeForTimeframe();
        });

        // æ ¹æ®æ—¶é—´æ¡†æ¶è‡ªåŠ¨è°ƒæ•´æ—¥æœŸèŒƒå›´
        function adjustDateRangeForTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            const today = new Date();
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            
            let maxDays = 365; // é»˜è®¤ä¸€å¹´
            if (timeframe === '1m') maxDays = 7;
            else if (['5m', '15m', '30m', '1h'].includes(timeframe)) maxDays = 60;
            
            const maxStartDate = new Date(today.getTime() - maxDays * 24 * 60 * 60 * 1000);
            
            // å¯¹äºæ—¥å†…æ•°æ®ï¼Œè‡ªåŠ¨è®¾ç½®åˆé€‚çš„æ—¥æœŸèŒƒå›´
            if (['1m', '5m', '15m', '30m', '1h'].includes(timeframe)) {
                // è®¾ç½®å¼€å§‹æ—¥æœŸä¸ºæœ€å¤§å…è®¸çš„å¼€å§‹æ—¥æœŸ
                startDateInput.value = maxStartDate.toISOString().split('T')[0];
                // è®¾ç½®ç»“æŸæ—¥æœŸä¸ºä»Šå¤©
                endDateInput.value = today.toISOString().split('T')[0];
            } else {
                // å¯¹äºæ—¥çº¿åŠä»¥ä¸Šï¼Œç¡®ä¿ç»“æŸæ—¥æœŸä¸è¶…è¿‡ä»Šå¤©
                if (new Date(endDateInput.value) > today) {
                    endDateInput.value = today.toISOString().split('T')[0];
                }
                
                // å¦‚æœå¼€å§‹æ—¥æœŸè¶…å‡ºé™åˆ¶ï¼Œè°ƒæ•´åˆ°æœ€å¤§å…è®¸çš„å¼€å§‹æ—¥æœŸ
                const currentStartDate = new Date(startDateInput.value);
                if (currentStartDate < maxStartDate) {
                    startDateInput.value = maxStartDate.toISOString().split('T')[0];
                }
            }
        }

        // åˆ†æè¡¨å•æäº¤
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const timeframe = document.getElementById('timeframe').value;
            
            if (!symbol || !startDate || !endDate || !timeframe) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è‚¡ç¥¨ä»£ç ã€æ—¥æœŸèŒƒå›´å’Œæ—¶é—´æ¡†æ¶');
                return;
            }
            
            // æ£€æŸ¥æ—¥å†…æ•°æ®çš„å†å²é™åˆ¶
            const intradayTimeframes = ['1m', '5m', '15m', '30m', '1h'];
            if (intradayTimeframes.includes(timeframe)) {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const daysDiff = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
                
                let maxDays = 60;
                if (timeframe === '1m') maxDays = 7;
                
                if (daysDiff > maxDays) {
                    alert(`è­¦å‘Šï¼š${timeframe}æ•°æ®æœ€å¤šåªèƒ½è·å–æœ€è¿‘${maxDays}å¤©çš„å†å²æ•°æ®ã€‚è¯·è°ƒæ•´æ—¥æœŸèŒƒå›´ã€‚`);
                    return;
                }
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'none';
            
            // å‘é€åˆ†æè¯·æ±‚
            axios.post(`${API_BASE}/analyze`, {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                timeframe: timeframe
            })
            .then(function(response) {
                document.getElementById('loadingSection').style.display = 'none';
                
                if (response.data.success) {
                    // æ˜¾ç¤ºåˆ†æä¿¡æ¯
                    document.getElementById('analysisInfo').textContent = `${symbol} (${timeframe}) - ${startDate} è‡³ ${endDate}`;
                    
                    // æ˜¾ç¤ºå›¾è¡¨
                    if (response.data.chart) {
                        document.getElementById('chartContainer').innerHTML = `<img src="${response.data.chart}" alt="ç¼ è®ºåˆ†æå›¾è¡¨" class="img-fluid">`;
                    }
                    
                    // æ˜¾ç¤ºæŠ¥å‘Š
                    if (response.data.report) {
                        displayReport(response.data.report);
                    }
                    
                    // æ˜¾ç¤ºäº¤æ˜“æŠ¥å‘Š
                    if (response.data.report && response.data.report.trading_report) {
                        displayTradingReport(response.data.report.trading_report);
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('validationSection').style.display = 'block';
                } else {
                    alert('åˆ†æå¤±è´¥ï¼š' + (response.data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(function(error) {
                document.getElementById('loadingSection').style.display = 'none';
                console.error('åˆ†æé”™è¯¯:', error);
                alert('åˆ†æå¤±è´¥ï¼š' + (error.response?.data?.error || error.message || 'ç½‘ç»œé”™è¯¯'));
            });
        });

        // éªŒè¯è¡¨å•æäº¤
        document.getElementById('validationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const validationDate = document.getElementById('validation_date').value;
            
            if (!symbol || !startDate || !endDate || !validationDate) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å‚æ•°');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('validateBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>éªŒè¯ä¸­...';
            document.getElementById('validateBtn').disabled = true;
            
            // å‘é€éªŒè¯è¯·æ±‚
            axios.post(`${API_BASE}/validate`, {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                validation_date: validationDate
            })
            .then(function(response) {
                if (response.data.success) {
                    displayValidationResults(response.data.accuracy);
                    document.getElementById('validationResults').style.display = 'block';
                } else {
                    alert('éªŒè¯å¤±è´¥ï¼š' + (response.data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(function(error) {
                console.error('éªŒè¯é”™è¯¯:', error);
                alert('éªŒè¯å¤±è´¥ï¼š' + (error.response?.data?.error || error.message || 'ç½‘ç»œé”™è¯¯'));
            })
            .finally(function() {
                document.getElementById('validateBtn').innerHTML = '<i class="fas fa-check me-2"></i>éªŒè¯å‡†ç¡®æ€§';
                document.getElementById('validateBtn').disabled = false;
            });
        });

        // é‡æ–°åˆ†ææŒ‰é’®
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'none';
            document.getElementById('validationResults').style.display = 'none';
        });

        // æ˜¾ç¤ºæŠ¥å‘Š
        function displayReport(report) {
            const reportContainer = document.getElementById('reportContainer');
            let html = '';
            
            // å¸‚åœºæ¦‚è§ˆ
            if (report.market_overview) {
                const market = report.market_overview;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-line me-2"></i>å¸‚åœºæ¦‚è§ˆ</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">$${market.current_price}</div>
                                    <div class="metric-label">å½“å‰ä»·æ ¼</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value ${market.price_change >= 0 ? 'accuracy-excellent' : 'accuracy-poor'}">${market.price_change >= 0 ? '+' : ''}${market.price_change_pct}%</div>
                                    <div class="metric-label">ä»·æ ¼å˜åŒ–</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${market.total_days}</div>
                                    <div class="metric-label">æ€»å¤©æ•°</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${market.date_range}</div>
                                    <div class="metric-label">æ—¥æœŸèŒƒå›´</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // åˆ†å‹åˆ†æ
            if (report.fractal_analysis) {
                const fractal = report.fractal_analysis;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-candlestick me-2"></i>åˆ†å‹åˆ†æ</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.total_fractals}</div>
                                    <div class="metric-label">æ€»åˆ†å‹æ•°</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.top_fractals}</div>
                                    <div class="metric-label">é¡¶åˆ†å‹</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.bottom_fractals}</div>
                                    <div class="metric-label">åº•åˆ†å‹</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">$${fractal.latest_fractal ? fractal.latest_fractal.price : 'N/A'}</div>
                                    <div class="metric-label">æœ€æ–°åˆ†å‹</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ç¬”åˆ†æ
            if (report.stroke_analysis) {
                const stroke = report.stroke_analysis;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-area me-2"></i>ç¬”åˆ†æ</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.total_strokes}</div>
                                    <div class="metric-label">æ€»ç¬”æ•°</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.up_strokes}</div>
                                    <div class="metric-label">ä¸Šæ¶¨ç¬”</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.down_strokes}</div>
                                    <div class="metric-label">ä¸‹è·Œç¬”</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.current_stroke ? stroke.current_stroke.direction : 'N/A'}</div>
                                    <div class="metric-label">å½“å‰ç¬”</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            reportContainer.innerHTML = html;
        }

        // æ˜¾ç¤ºäº¤æ˜“æŠ¥å‘Š
        function displayTradingReport(tradingReport) {
            const tradingReportContainer = document.getElementById('tradingReportContainer');
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>äº¤æ˜“æŠ¥å‘Š</h5>
                    </div>
                    <div class="card-body">
            `;
            
            if (tradingReport.horizon) {
                const horizon = tradingReport.horizon;
                
                // é•¿çº¿ä¿¡å·
                if (horizon.long) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>é•¿çº¿ (Long-term) - å»ºè®®ä»“ä½: ${horizon.long.position_pct}%</h6>
                    `;
                    
                    if (horizon.long.buy_signals && horizon.long.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>ä¹°å…¥ä¿¡å·:</strong><ul class="mb-0">';
                        horizon.long.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>ä¹°å…¥ä¿¡å·:</strong> æ— </div>';
                    }
                    
                    if (horizon.long.sell_signals && horizon.long.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>å–å‡ºä¿¡å·:</strong><ul class="mb-0">';
                        horizon.long.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>å–å‡ºä¿¡å·:</strong> æ— </div>';
                    }
                    
                    html += '</div></div>';
                }
                
                // ä¸­çº¿ä¿¡å·
                if (horizon.mid) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>ä¸­çº¿ (Medium-term) - å»ºè®®ä»“ä½: ${horizon.mid.position_pct}%</h6>
                    `;
                    
                    if (horizon.mid.buy_signals && horizon.mid.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>ä¹°å…¥ä¿¡å·:</strong><ul class="mb-0">';
                        horizon.mid.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>ä¹°å…¥ä¿¡å·:</strong> æ— </div>';
                    }
                    
                    if (horizon.mid.sell_signals && horizon.mid.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>å–å‡ºä¿¡å·:</strong><ul class="mb-0">';
                        horizon.mid.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>å–å‡ºä¿¡å·:</strong> æ— </div>';
                    }
                    
                    html += '</div></div>';
                }
                
                // çŸ­çº¿ä¿¡å·
                if (horizon.short) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>çŸ­çº¿ (Short-term) - å»ºè®®ä»“ä½: ${horizon.short.position_pct}%</h6>
                    `;
                    
                    if (horizon.short.buy_signals && horizon.short.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>ä¹°å…¥ä¿¡å·:</strong><ul class="mb-0">';
                        horizon.short.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>ä¹°å…¥ä¿¡å·:</strong> æ— </div>';
                    }
                    
                    if (horizon.short.sell_signals && horizon.short.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>å–å‡ºä¿¡å·:</strong><ul class="mb-0">';
                        horizon.short.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (æ­¢æŸ: $${signal.stop}, ç›®æ ‡: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>å–å‡ºä¿¡å·:</strong> æ— </div>';
                    }
                    
                    html += '</div></div>';
                }
            }
            
            // é£é™©ç­‰çº§
            if (tradingReport.risk_level) {
                const riskClass = tradingReport.risk_level === 'é«˜' ? 'danger' : tradingReport.risk_level === 'ä¸­' ? 'warning' : 'success';
                html += `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>é£é™©ç­‰çº§</h6>
                            <div class="alert alert-${riskClass}">
                                <strong>${tradingReport.risk_level}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ“ä½œå»ºè®®
            if (tradingReport.advice && tradingReport.advice.length > 0) {
                html += `
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-lightbulb me-2"></i>æ“ä½œå»ºè®®</h6>
                            <div class="alert alert-info">
                                <ul class="mb-0">
                `;
                tradingReport.advice.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
            tradingReportContainer.innerHTML = html;
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayValidationResults(accuracy) {
            const validationResults = document.getElementById('validationResults');
            
            // å…¼å®¹ä¸åŒçš„æ•°æ®æ ¼å¼
            const metrics = accuracy.metrics || accuracy;
            const chart = accuracy.chart || null;
            
            const overallScore = metrics.overall_accuracy;
            let scoreClass = 'accuracy-poor';
            if (overallScore >= 80) scoreClass = 'accuracy-excellent';
            else if (overallScore >= 70) scoreClass = 'accuracy-good';
            else if (overallScore >= 60) scoreClass = 'accuracy-fair';
            
            let html = `
                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-chart-line me-2"></i>å‡†ç¡®æ€§è¯„ä¼°ç»“æœ</h5>
                        <div class="text-center mb-4">
                            <div class="accuracy-score ${scoreClass}">${overallScore}%</div>
                            <p class="text-muted">æ€»ä½“å‡†ç¡®æ€§è¯„åˆ†</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${metrics.fractal_accuracy}%</div>
                            <div class="metric-label">åˆ†å‹å‡†ç¡®æ€§</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${metrics.stroke_accuracy}%</div>
                            <div class="metric-label">ç¬”å‡†ç¡®æ€§</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${metrics.price_accuracy}%</div>
                            <div class="metric-label">ä»·æ ¼é¢„æµ‹</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${metrics.trend_accuracy}%</div>
                            <div class="metric-label">è¶‹åŠ¿é¢„æµ‹</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">éªŒè¯ä¿¡æ¯</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>å†å²æœŸé—´ï¼š</strong>${metrics.validation_info.historical_period}</p>
                                <p><strong>éªŒè¯æœŸé—´ï¼š</strong>${metrics.validation_info.validation_period}</p>
                                <p><strong>å†å²ä»·æ ¼ï¼š</strong>$${metrics.validation_info.historical_price}</p>
                                <p><strong>å®é™…ä»·æ ¼ï¼š</strong>$${metrics.validation_info.actual_price}</p>
                                <p><strong>ä»·æ ¼å˜åŒ–ï¼š</strong>$${metrics.validation_info.price_change}</p>
                            </div>
                        </div>
                    </div>
                </div>

                ${chart ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">è®­ç»ƒæœŸä¸æœªæ¥æœŸå¯¹æ¯”å›¾</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <img src="${chart}" alt="Validation Comparison" class="img-fluid" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>` : ''}
            `;
            
            validationResults.innerHTML = html;
        }

        // æ˜¾ç¤ºæ–°æ‰‹æ‰‹å†Œ
        function showHandbook() {
            alert('æ–°æ‰‹æ‰‹å†ŒåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        // æ˜¾ç¤ºå®‰è£…æŒ‡å¯¼
        function showInstallGuide() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            let message = '';
            
            if (isIOS) {
                message = `ğŸ“± å¦‚ä½•å°†åº”ç”¨æ·»åŠ åˆ°ä¸»å±å¹•ï¼š
                
1. ç‚¹å‡»Safariåº•éƒ¨çš„åˆ†äº«æŒ‰é’® (â–¡â†‘)
2. å‘ä¸‹æ»šåŠ¨æ‰¾åˆ°"æ·»åŠ åˆ°ä¸»å±å¹•"
3. ç‚¹å‡»"æ·»åŠ åˆ°ä¸»å±å¹•"
4. ç‚¹å‡»"æ·»åŠ "æŒ‰é’®
5. åº”ç”¨å›¾æ ‡å°†å‡ºç°åœ¨ä¸»å±å¹•ä¸Š

æ³¨æ„ï¼šç¡®ä¿åœ¨Safariä¸­è®¿é—®ï¼Œä¸æ˜¯å…¶ä»–æµè§ˆå™¨`;
            } else {
                message = `ğŸ’» æ¡Œé¢ç«¯å®‰è£…ï¼š
                
Chrome/Edge: åœ°å€æ å³ä¾§ä¼šå‡ºç°å®‰è£…å›¾æ ‡
Firefox: åœ°å€æ å³ä¾§ä¼šå‡ºç°å®‰è£…å›¾æ ‡
Safari: èœå•æ  â†’ æ–‡ä»¶ â†’ æ·»åŠ åˆ°Dock`;
            }
            
            alert(message);
        }

        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        } else {
            console.log('Service Worker not supported');
        }
    </script>
</body>
</html>
