<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>缠论技术分析系统 - 移动版</title>
    
    <!-- PWA支持 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="缠论分析">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }
        .card-header {
            background-color: #2c3e50;
            color: white;
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }
        .btn-primary {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
        .btn-primary:hover {
            background-color: #34495e;
            border-color: #34495e;
        }
        .form-control:focus {
            border-color: #2c3e50;
            box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
        }
        .loading {
            display: none;
        }
        .chart-container {
            text-align: center;
            margin: 20px 0;
        }
        .chart-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        
        /* 美化表单样式 */
        .form-control-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
        }
        
        .form-select-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        
        .form-label {
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* 卡片间距优化 */
        .card-body {
            padding: 2rem;
        }
        
        /* 按钮悬停效果 */
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease-in-out;
        }
        
        /* 输入框聚焦效果 */
        .form-control:focus, .form-select:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.15);
            transition: all 0.2s ease-in-out;
        }
        .accuracy-score {
            font-size: 2rem;
            font-weight: bold;
        }
        .accuracy-excellent { color: #28a745; }
        .accuracy-good { color: #17a2b8; }
        .accuracy-fair { color: #ffc107; }
        .accuracy-poor { color: #dc3545; }
        .report-section {
            margin-bottom: 30px;
        }
        .report-section h5 {
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 5px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 20px;
            margin-bottom: 15px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem;
            }
            .btn-lg {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
            .form-control-lg, .form-select-lg {
                padding: 0.5rem 0.75rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>缠论技术分析系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarsExampleDefault">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHandbook()"><i class="fas fa-book me-1"></i>新手手册</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 分析表单 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-candlestick me-2"></i>缠论技术分析
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="analysisForm">
                            <div class="row g-3">
                                <!-- 第一行：股票代码和时间框架 -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="symbol" class="form-label fw-bold">股票代码</label>
                                        <input type="text" class="form-control form-control-lg" id="symbol" placeholder="例如: AAPL" value="AAPL" required>
                                        <div class="form-text">请输入股票代码</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="timeframe" class="form-label fw-bold">时间框架</label>
                                        <select class="form-select form-select-lg" id="timeframe" required>
                                            <option value="1m">分线 (1分钟) - 最近7天</option>
                                            <option value="5m">5分钟 - 最近60天</option>
                                            <option value="15m">15分钟 - 最近60天</option>
                                            <option value="30m">30分钟 - 最近60天</option>
                                            <option value="1h">小时线 - 最近60天</option>
                                            <option value="1d" selected>日线 - 完整历史</option>
                                            <option value="1wk">周线 - 完整历史</option>
                                            <option value="1mo">月线 - 完整历史</option>
                                        </select>
                                        <div class="form-text">选择K线周期（日内数据仅限最近历史）</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary btn-lg w-100" id="analyzeBtn">
                                                <i class="fas fa-search me-2"></i>开始分析
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 第二行：日期选择 -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start_date" class="form-label fw-bold">开始日期</label>
                                        <input type="date" class="form-control form-control-lg" id="start_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="end_date" class="form-label fw-bold">结束日期</label>
                                        <input type="date" class="form-control form-control-lg" id="end_date" required>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="row mt-4 loading" id="loadingSection">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">分析中...</span>
                        </div>
                        <p class="mt-3 mb-0">正在分析数据，请稍候...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析结果 -->
        <div class="row mt-4" id="resultsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>分析结果
                            <span id="analysisInfo" class="badge bg-light text-dark ms-2"></span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- 缠论图表 -->
                        <div class="chart-container" id="chartContainer">
                            <!-- 图表将在这里显示 -->
                        </div>
                        
                        <!-- 评估报告 -->
                        <div id="reportContainer">
                            <!-- 报告将在这里显示 -->
                        </div>

                        <!-- 交易报告 -->
                        <div class="mt-4" id="tradingReportContainer">
                            <!-- 交易报告将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 准确性验证 -->
        <div class="row mt-4" id="validationSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>准确性验证
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="validationForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="validation_date" class="form-label fw-bold">验证日期</label>
                                        <input type="date" class="form-control form-control-lg" id="validation_date" required>
                                        <div class="form-text">选择要验证的截止日期</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-success btn-lg w-100" id="validateBtn">
                                                <i class="fas fa-check me-2"></i>验证准确性
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="button" class="btn btn-secondary btn-lg w-100" id="resetBtn">
                                                <i class="fas fa-refresh me-2"></i>重新分析
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- 验证结果 -->
                        <div id="validationResults" style="display: none;">
                            <!-- 验证结果将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>使用说明
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-candlestick me-2"></i>分析功能</h6>
                                <ul>
                                    <li><strong>分型识别</strong>：自动识别顶分型和底分型</li>
                                    <li><strong>笔构建</strong>：连接分型形成笔结构</li>
                                    <li><strong>线段分析</strong>：识别主要趋势线段</li>
                                    <li><strong>中枢检测</strong>：发现价格震荡区间</li>
                                    <li><strong>背驰分析</strong>：基于MACD的背驰信号</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-check-circle me-2"></i>验证功能</h6>
                                <ul>
                                    <li><strong>分型准确性</strong>：验证分型识别准确性</li>
                                    <li><strong>笔准确性</strong>：验证笔构建准确性</li>
                                    <li><strong>价格预测</strong>：验证价格预测准确性</li>
                                    <li><strong>趋势预测</strong>：验证趋势预测准确性</li>
                                    <li><strong>综合评分</strong>：整体分析质量评估</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2024 缠论技术分析系统. 基于缠论理论的专业分析工具.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE = 'https://chan-stock-theory.onrender.com';
        
        // 设置默认日期
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            
            document.getElementById('start_date').value = oneYearAgo.toISOString().split('T')[0];
            document.getElementById('end_date').value = today.toISOString().split('T')[0];
            document.getElementById('validation_date').value = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            // 监听时间框架变化，自动调整日期范围
            document.getElementById('timeframe').addEventListener('change', function() {
                adjustDateRangeForTimeframe();
            });
            
            // 页面加载时也自动调整日期范围
            adjustDateRangeForTimeframe();
        });

        // 根据时间框架自动调整日期范围
        function adjustDateRangeForTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            const today = new Date();
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            
            let maxDays = 365; // 默认一年
            if (timeframe === '1m') maxDays = 7;
            else if (['5m', '15m', '30m', '1h'].includes(timeframe)) maxDays = 60;
            
            const maxStartDate = new Date(today.getTime() - maxDays * 24 * 60 * 60 * 1000);
            
            // 对于日内数据，自动设置合适的日期范围
            if (['1m', '5m', '15m', '30m', '1h'].includes(timeframe)) {
                // 设置开始日期为最大允许的开始日期
                startDateInput.value = maxStartDate.toISOString().split('T')[0];
                // 设置结束日期为今天
                endDateInput.value = today.toISOString().split('T')[0];
            } else {
                // 对于日线及以上，确保结束日期不超过今天
                if (new Date(endDateInput.value) > today) {
                    endDateInput.value = today.toISOString().split('T')[0];
                }
                
                // 如果开始日期超出限制，调整到最大允许的开始日期
                const currentStartDate = new Date(startDateInput.value);
                if (currentStartDate < maxStartDate) {
                    startDateInput.value = maxStartDate.toISOString().split('T')[0];
                }
            }
        }

        // 分析表单提交
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const timeframe = document.getElementById('timeframe').value;
            
            if (!symbol || !startDate || !endDate || !timeframe) {
                alert('请填写完整的股票代码、日期范围和时间框架');
                return;
            }
            
            // 检查日内数据的历史限制
            const intradayTimeframes = ['1m', '5m', '15m', '30m', '1h'];
            if (intradayTimeframes.includes(timeframe)) {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const daysDiff = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
                
                let maxDays = 60;
                if (timeframe === '1m') maxDays = 7;
                
                if (daysDiff > maxDays) {
                    alert(`警告：${timeframe}数据最多只能获取最近${maxDays}天的历史数据。请调整日期范围。`);
                    return;
                }
            }
            
            // 显示加载状态
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'none';
            
            // 发送分析请求
            axios.post(`${API_BASE}/analyze`, {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                timeframe: timeframe
            })
            .then(function(response) {
                document.getElementById('loadingSection').style.display = 'none';
                
                if (response.data.success) {
                    // 显示分析信息
                    document.getElementById('analysisInfo').textContent = `${symbol} (${timeframe}) - ${startDate} 至 ${endDate}`;
                    
                    // 显示图表
                    if (response.data.chart) {
                        document.getElementById('chartContainer').innerHTML = `<img src="${response.data.chart}" alt="缠论分析图表" class="img-fluid">`;
                    }
                    
                    // 显示报告
                    if (response.data.report) {
                        displayReport(response.data.report);
                    }
                    
                    // 显示交易报告
                    if (response.data.report && response.data.report.trading_report) {
                        displayTradingReport(response.data.report.trading_report);
                    }
                    
                    // 显示结果
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('validationSection').style.display = 'block';
                } else {
                    alert('分析失败：' + (response.data.error || '未知错误'));
                }
            })
            .catch(function(error) {
                document.getElementById('loadingSection').style.display = 'none';
                console.error('分析错误:', error);
                alert('分析失败：' + (error.response?.data?.error || error.message || '网络错误'));
            });
        });

        // 验证表单提交
        document.getElementById('validationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const validationDate = document.getElementById('validation_date').value;
            
            if (!symbol || !startDate || !endDate || !validationDate) {
                alert('请填写完整的参数');
                return;
            }
            
            // 显示加载状态
            document.getElementById('validateBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>验证中...';
            document.getElementById('validateBtn').disabled = true;
            
            // 发送验证请求
            axios.post(`${API_BASE}/validate`, {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                validation_date: validationDate
            })
            .then(function(response) {
                if (response.data.success) {
                    displayValidationResults(response.data.accuracy);
                    document.getElementById('validationResults').style.display = 'block';
                } else {
                    alert('验证失败：' + (response.data.error || '未知错误'));
                }
            })
            .catch(function(error) {
                console.error('验证错误:', error);
                alert('验证失败：' + (error.response?.data?.error || error.message || '网络错误'));
            })
            .finally(function() {
                document.getElementById('validateBtn').innerHTML = '<i class="fas fa-check me-2"></i>验证准确性';
                document.getElementById('validateBtn').disabled = false;
            });
        });

        // 重新分析按钮
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'none';
            document.getElementById('validationResults').style.display = 'none';
        });

        // 显示报告
        function displayReport(report) {
            const reportContainer = document.getElementById('reportContainer');
            let html = '';
            
            // 市场概览
            if (report.market_overview) {
                const market = report.market_overview;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-line me-2"></i>市场概览</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">$${market.current_price}</div>
                                    <div class="metric-label">当前价格</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value ${market.price_change >= 0 ? 'accuracy-excellent' : 'accuracy-poor'}">${market.price_change >= 0 ? '+' : ''}${market.price_change_pct}%</div>
                                    <div class="metric-label">价格变化</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${market.total_days}</div>
                                    <div class="metric-label">总天数</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${market.date_range}</div>
                                    <div class="metric-label">日期范围</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 分型分析
            if (report.fractal_analysis) {
                const fractal = report.fractal_analysis;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-candlestick me-2"></i>分型分析</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.total_fractals}</div>
                                    <div class="metric-label">总分型数</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.top_fractals}</div>
                                    <div class="metric-label">顶分型</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${fractal.bottom_fractals}</div>
                                    <div class="metric-label">底分型</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">$${fractal.latest_fractal ? fractal.latest_fractal.price : 'N/A'}</div>
                                    <div class="metric-label">最新分型</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 笔分析
            if (report.stroke_analysis) {
                const stroke = report.stroke_analysis;
                html += `
                    <div class="report-section">
                        <h5><i class="fas fa-chart-area me-2"></i>笔分析</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.total_strokes}</div>
                                    <div class="metric-label">总笔数</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.up_strokes}</div>
                                    <div class="metric-label">上涨笔</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.down_strokes}</div>
                                    <div class="metric-label">下跌笔</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${stroke.current_stroke ? stroke.current_stroke.direction : 'N/A'}</div>
                                    <div class="metric-label">当前笔</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            reportContainer.innerHTML = html;
        }

        // 显示交易报告
        function displayTradingReport(tradingReport) {
            const tradingReportContainer = document.getElementById('tradingReportContainer');
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>交易报告</h5>
                    </div>
                    <div class="card-body">
            `;
            
            if (tradingReport.horizon) {
                const horizon = tradingReport.horizon;
                
                // 长线信号
                if (horizon.long) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>长线 (Long-term) - 建议仓位: ${horizon.long.position_pct}%</h6>
                    `;
                    
                    if (horizon.long.buy_signals && horizon.long.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>买入信号:</strong><ul class="mb-0">';
                        horizon.long.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>买入信号:</strong> 无</div>';
                    }
                    
                    if (horizon.long.sell_signals && horizon.long.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>卖出信号:</strong><ul class="mb-0">';
                        horizon.long.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>卖出信号:</strong> 无</div>';
                    }
                    
                    html += '</div></div>';
                }
                
                // 中线信号
                if (horizon.mid) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>中线 (Medium-term) - 建议仓位: ${horizon.mid.position_pct}%</h6>
                    `;
                    
                    if (horizon.mid.buy_signals && horizon.mid.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>买入信号:</strong><ul class="mb-0">';
                        horizon.mid.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>买入信号:</strong> 无</div>';
                    }
                    
                    if (horizon.mid.sell_signals && horizon.mid.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>卖出信号:</strong><ul class="mb-0">';
                        horizon.mid.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>卖出信号:</strong> 无</div>';
                    }
                    
                    html += '</div></div>';
                }
                
                // 短线信号
                if (horizon.short) {
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-line me-2"></i>短线 (Short-term) - 建议仓位: ${horizon.short.position_pct}%</h6>
                    `;
                    
                    if (horizon.short.buy_signals && horizon.short.buy_signals.length > 0) {
                        html += '<div class="alert alert-success"><strong>买入信号:</strong><ul class="mb-0">';
                        horizon.short.buy_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>买入信号:</strong> 无</div>';
                    }
                    
                    if (horizon.short.sell_signals && horizon.short.sell_signals.length > 0) {
                        html += '<div class="alert alert-danger"><strong>卖出信号:</strong><ul class="mb-0">';
                        horizon.short.sell_signals.forEach(signal => {
                            html += `<li>$${signal.position} - ${signal.reason} (止损: $${signal.stop}, 目标: $${signal.target})</li>`;
                        });
                        html += '</ul></div>';
                    } else {
                        html += '<div class="alert alert-secondary"><strong>卖出信号:</strong> 无</div>';
                    }
                    
                    html += '</div></div>';
                }
            }
            
            // 风险等级
            if (tradingReport.risk_level) {
                const riskClass = tradingReport.risk_level === '高' ? 'danger' : tradingReport.risk_level === '中' ? 'warning' : 'success';
                html += `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>风险等级</h6>
                            <div class="alert alert-${riskClass}">
                                <strong>${tradingReport.risk_level}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 操作建议
            if (tradingReport.advice && tradingReport.advice.length > 0) {
                html += `
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-lightbulb me-2"></i>操作建议</h6>
                            <div class="alert alert-info">
                                <ul class="mb-0">
                `;
                tradingReport.advice.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
            tradingReportContainer.innerHTML = html;
        }

        // 显示验证结果
        function displayValidationResults(accuracy) {
            const validationResults = document.getElementById('validationResults');
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>验证结果</h5>
                    </div>
                    <div class="card-body">
            `;
            
            // 检查是否是标准准确性格式
            if (accuracy.overall_accuracy) {
                html += `
                    <div class="row">
                        <div class="col-12 text-center mb-4">
                            <div class="accuracy-score accuracy-excellent">${accuracy.overall_accuracy}%</div>
                            <div class="h5">总体准确性评分</div>
                        </div>
                    </div>
                    <div class="row">
                `;
                
                const accuracyMetrics = [
                    { key: 'fractal_accuracy', label: '分型准确性' },
                    { key: 'stroke_accuracy', label: '笔准确性' },
                    { key: 'price_prediction_accuracy', label: '价格预测准确性' },
                    { key: 'trend_prediction_accuracy', label: '趋势预测准确性' }
                ];
                
                accuracyMetrics.forEach(metric => {
                    if (accuracy[metric.key]) {
                        html += `
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">${accuracy[metric.key]}%</div>
                                    <div class="metric-label">${metric.label}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
            } else {
                // 显示原始数据格式
                html += '<div class="alert alert-info"><pre>' + JSON.stringify(accuracy, null, 2) + '</pre></div>';
            }
            
            html += '</div></div>';
            validationResults.innerHTML = html;
        }

        // 显示新手手册
        function showHandbook() {
            alert('新手手册功能正在开发中...');
        }

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }
    </script>
</body>
</html>
